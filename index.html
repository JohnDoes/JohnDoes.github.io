<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <title>LngLrn</title>
  <link rel='stylesheet' href='style.css' type='text/css' media='all' />
  <script src='assets/talk.js' type="text/javascript"></script>
  <script>
      var jsonData = JSON.stringify(dataSet);
  </script>
</head>
<body>

    <div class="chat_container">

  <!-- ▼LINE風ここから -->
  <div class="line__container">
    <!-- タイトル -->
    <div class="line__title">
      Language Laerning
      <a onclick="cancel()" style="float: right;" class="btn btn--orange">終了</a>
     </div>

    <!-- ▼会話エリア scrollを外すと高さ固定解除 -->
    <div id="chatArea" class="line__contents scroll">

    </div>
    <!--　▲会話エリア ここまで -->
  </div>
  <!--　▲LINE風ここまで -->
  <div class="message-area">
    <div class="message-area-text">
      <textarea id="text"></textarea>
    </div>
    <div class="message-area-button">
      <button id="send" class="disabled-button" onclick="sendMessage()">送信</button>
    </div>
    </div>

    </div>
<script>

var sceneData = JSON.parse(jsonData);
    console.log(sceneData);

    var lngID = '設定';
    var stgID = 0;
    var logID = 1;
    var Char = 1;
    var Name = 'navigator';
    var Log = 'どの言語を学びたい？<form method="post" onchange="changeLang(this.value)" id="lng"><select name="pref"><option value=0>言語を選択</option><option value=1>ドイツ語</option><option value=2>フランス語</option><option value=3>ロシア語</option></select></form>';
    var icon = "";
    var i = 0;
    var nextLng = 'ドイツ語';
    var nextStg = 0;
    var nextLog = 2;
    var answer = "";
    var status = "a";


    var scene1 = sceneData.filter(function(scene){
        return scene.LangID == lngID;
    });
    console.log(scene1);
    var scene2 = scene1.filter(function(scene){
        return scene.StageID == stgID;
    });
    console.log(scene2);
    var scene3 = scene2.filter(function(scene){
        return scene.LogID == logID.toString();
    });
    console.log(scene3);
    judgeChat(scene3[0]);


    function judgeChat(data) {
        console.log(data);
        status = data.type;
        console.log(status);
        switch(status){
            case "a":
                botloading(data);
                logID +=1
				window.setTimeout(scenario,6000);				
                break;
            case "b":
                makeQ(data);
                logID +=1
                break;
            case "q":
                answer = data.Log;
				console.log(answer);
                logID +=1
                break;
            case "e":
				if(nextStg==stgID){
					nextStg = stgID + 1;
				}
                botloading(data);
				window.setTimeout(nxtStage,2000);				
                break;
            default:

        }
		scroll();

    }

    function makeQ(data){
        console.log(data);
        switch (data.LogID){
            case "1":
                var el = document.createElement("div");
                console.log(el);
                document.getElementById("chatArea").appendChild(el);
                el.setAttribute("class", "line__left");
                el.innerHTML = '<div class="stamp"><img src="assets/gif/load.gif" /></div>'
                window.setTimeout( function() {
                    el.innerHTML = '<div class="line__left"><figure><img src='+
                        data.icon +' /></figure><div class="line__left-text"><div class="name">'+ 
                        data.Name +'</div><div class="text">' + data.Log + '<form method="post" onchange="changeLang()" name="lang"><select name="lng" id="lng"><option value=0>言語を選択</option><option value=1>ドイツ語</option><option value=2>フランス語</option><option value=3>ロシア語</option></select></form></div></div></div>';
                }, 2000 );
                scroll();
                break;
            case "2":
            var el = document.createElement("div");
                el.setAttribute("class", "line__left");
                el.innerHTML = '<div class="stamp"><img src="assets/gif/load.gif" /></div>'
                document.getElementById("chatArea").appendChild(el);
                window.setTimeout( function() {
                    el.innerHTML = '<div class="line__left"><figure><img src='+
                        data.icon +' /></figure><div class="line__left-text"><div class="name">'+ 
                        data.Name +'</div><div class="text">' + data.Log + '<form method="post" onchange="changeStage()" name="stage"><select name="stg" id="stg"><option value=0>数字を選択</option><option value=1>1</option><option value=2>2</option><option value=3>3</option><option value=4>4</option><option value=5>5</option><option value=6>6</option><option value=7>7</option><option value=8>8</option><option value=9>9</option><option value=10>10</option><option value=11>11</option><option value=12>12</option><option value=13>13</option><option value=14>14</option><option value=15>15</option><option value=16>16</option><option value=17>17</option><option value=18>18</option><option value=19>19</option><option value=20>20</option><option value=21>21</option><option value=22>22</option><option value=23>23</option><option value=24>24</option><option value=25>25</option><option value=26>26</option><option value=27>27</option><option value=28>28</option><option value=29>29</option><option value=30>30</option><option value=31>31</option><option value=32>32</option><option value=33>33</option><option value=34>34</option><option value=35>35</option><option value=36>36</option><option value=37>37</option><option value=38>38</option><option value=39>39</option><option value=40>40</option></select></form></div></div></div>';
                }, 2000 );
                scroll();
                break;
            default:
        }
    }

	var filter1 = new RegExp('[A-Z]');
	var filter2 = new RegExp('\L$1');
	var filter3 = new RegExp('\s');
	var filter4 = new RegExp('');
	var filter5 = new RegExp('/n');
	var filter6 = new RegExp('');
	var hanbetsu = new RegExp('.+', 'is');
	var ansArr, messageArr;
    function sendMessage() {
        var message = document.getElementById("text").value;
		console.log(message);
		console.log(status);


        if(status = "q"){
            if (message) {
			console.log(message);
            mychat(message);

			//正規表現の正誤判定
			
			ansArr = answer.toLowerCase();
			ansArr = ansArr.replace(/\s|　/g,"");
			messageArr = message.toLowerCase();
			messageArr = messageArr.replace(/\s|　/g,"");
				console.log(ansArr);
				console.log(messageArr);

                if(ansArr == messageArr) {
                    scenario();
                }else {
                    var el = document.createElement("div");
                    el.setAttribute("class", "line__left");
                    el.innerHTML = '<div class="stamp"><img src="assets/gif/load.gif" /></div>'
                    document.getElementById("chatArea").appendChild(el);
                    window.setTimeout( wrongAns(el), 3000 )
                }

				/*
				//正規表現なし
                if(answer == message) {
                    scenario();
                }else {
                    var el = document.createElement("div");
                    el.setAttribute("class", "line__left");
                    el.innerHTML = '<div class="stamp"><img src="assets/gif/load.gif" /></div>'
                    document.getElementById("chatArea").appendChild(el);
                    window.setTimeout( wrongAns(el), 3000 )
                }
				*/


            }
            scroll();
        }
        document.getElementById("text").value = "";
    };

    function wrongAns(el) {
        el.innerHTML = '<div class="line__left"><figure>'+
            '<img src="assets/icons/image014.png" />'+
            '</figure><div class="line__left-text"><div class="name">Navigator</div>'+
            '<div class="text">何かのミスがあるようです。もう一度回答をお願いします。またはスキップしますか？'+
                '<a onclick="skip()" class="btn btn--orange">スキップ</a></div></div></div>';
    }

    function skip(){
		scenario();
    }

    /*
	function botchat(data, el) {
        el.innerHTML = '<div class="line__left"><figure><img src='+
            data.icon +' /></figure><div class="line__left-text"><div class="name">'+ 
                data.Name +'</div><div class="text">' + data.Log + '</div></div></div>';
    }
	*/
    function botloading(data){
        console.log(data);
        var el = document.createElement("div");
        el.setAttribute("class", "line__left");
        el.innerHTML = '<div class="stamp"><img src="assets/gif/load.gif" /></div>'
        document.getElementById("chatArea").appendChild(el);
        window.setTimeout( function () {
			el.innerHTML = '<div class="line__left"><figure><img src='+
            data.icon +' /></figure><div class="line__left-text"><div class="name">'+ 
                data.Name +'</div><div class="text">' + data.Log + '</div></div></div>';

		}, 5000 )
    }
    function mychat(msg){
        var el = document.createElement("div");
        el.setAttribute("class", "line__right");
        el.innerHTML = '<div class="line__right"><div class="text">'+ msg +'</div></div>';
        document.getElementById("chatArea").appendChild(el);
    }

    function cancel(){
        lngID = "設定";
        stgID = 0;
        logID = 1;
		scenario();				
    }
    function changeLang() {
		var k = document.getElementById("lng").value;
		console.log(k);
        switch(k){
            case "0":
                nextLng = "設定";
                break;
            case "1":
                nextLng = "ドイツ語";
                break;
            case "2":
                nextLng = "フランス語";
                break;
            default:
        }
		console.log(nextLng);
		scenario();				
    }
    function changeStage(){
		var l = document.getElementById("stg").value;
		console.log(l);
        nextStg = l;
		scenario();				
    }
    function nxtStage(){
        logID = 1;
        stgID = nextStg;
		console.log(stgID);
        lngID = nextLng;
		scenario();				
        nextStg +=1;
    }
    function scenario(){
        scene1 = sceneData.filter(function(scene){
            return scene.LangID == lngID;
        });
        scene2 = scene1.filter(function(scene){
            return scene.StageID == stgID.toString();
        });
        scene3 = scene2.filter(function(scene){
            return scene.LogID == logID.toString();
        });
        console.log(lngID);
        console.log(stgID);
        console.log(logID);
        console.log(scene1);
        console.log(scene2);
        console.log(scene3);
        window.setTimeout(judgeChat(scene3[0]),5000);
    }

    /*
    var container;
    function scroll() {
        container = document.getElementById("chatArea");
        console.log(isScrollBottom());
        if (isScrollBottom()) {
            scrollToBottom();
        }else{
            scrollToBottom();
        }
    }
    // 下までスクロールする
    function scrollToBottom() {
        if(container.scrollTop&&container.scrollHeight){
            container.scrollTop = container.scrollHeight;
        }
    }
    // 一番下までスクロールしているかどうか
    function isScrollBottom() {
        if(container.scrollTop&&container.scrollHeight){
            return container.scrollHeight === container.scrollTop + container.offsetHeight;
        }
    }
    */
    var container;
    function scroll() {
        container = document.getElementById("chatArea");
        container.scrollBy({
            top: 60000,
            behavior: 'smooth'
        });
    }



</script>
</body>

</html>
